<div class="table-container">
  <div class="table-actions">
    @if (route.snapshot.queryParams['name']) {
      <div class="search-status">
        Showing results for: "{{ route.snapshot.queryParams['name'] }}"
        <button mat-button (click)="clearSearch()">Clear Search</button>
      </div>
    }
    @if (this.getClearanceLevel() >= 2) {
      <button (click)="toggleEditMode()" class="edit-button" color="primary" mat-raised-button>
        {{ isEditMode ? 'Cancel Editing' : 'Edit Products' }}
      </button>
    }
    @if (isEditMode) {
      <button class="edit-button" mat-raised-button color="primary" (click)="saveChanges()">
        Save Changes
      </button>
    }
  </div>

  @if (loading) {
    <div class="loading-spinner">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  }

  @if (!loading && products.length === 0) {
    <div class="no-results">
      No products found. @if (route.snapshot.queryParams['name']) {
      Try a different search term.
    }
    </div>
  }

  <form [formGroup]="productForm">
    <table>
      <thead>
      <tr>
        <th>Name</th>
        <th>Stock</th>
        <th>Category</th>
        @if (hasImage()) {
          <th>Image</th>
        }
        <th>Description</th>
        @if (!isEditMode) {
          <th>Actions</th>
        }
      </tr>
      </thead>
      <tbody formArrayName="products">
        @if (isEditMode) {
          @for (productGroup of productsFormArray.controls; track $index) {
            <tr [formGroupName]="$index">
              <td>
                <mat-form-field appearance="fill">
                  <input matInput [formControlName]="'name'" class="custom-input">
                </mat-form-field>
              </td>
              <td>
                <mat-form-field>
                  <input matInput type="number" [formControlName]="'stock'" class="custom-input">
                </mat-form-field>
              </td>
              <td>
                <mat-form-field>
                  <input matInput [formControlName]="'category'" class="custom-input">
                </mat-form-field>
              </td>
              <td>
                <mat-form-field>
                  <input matInput [formControlName]="'description'" class="custom-input">
                </mat-form-field>
              </td>
            </tr>
          }
        } @else {
          @for (product of products; track $index) {
            <tr>
              <td>{{ product.name }}</td>
              <td>{{ product.stock }}</td>
              <td>{{ product.category }}</td>
              <td>{{ product.description }}</td>
              @if (hasImage()) {
                <td>
                  <img [ngSrc]="product.image" height="50" width="50" alt="No image available"/>
                </td>
              }
              <td>
                <button class="edit-button" color="primary" mat-raised-button (click)="goToEdit(product)">
                  Edit
                </button>
                <button class="edit-button" color="warn" mat-raised-button (click)="deleteProduct(product.id)">
                  Delete
                </button>
              </td>
            </tr>
          }
        }
      </tbody>

    </table>
  </form>
</div>
