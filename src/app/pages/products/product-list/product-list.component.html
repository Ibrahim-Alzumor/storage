<div class="table-container">
  <div class="table-actions">
    @if (route.snapshot.queryParams['name']) {
      <div class="search-status">
        Showing results for: "{{ route.snapshot.queryParams['name'] }}"
        <button mat-button (click)="clearSearch()">Clear Search</button>
      </div>
    }
    @if (this.getClearanceLevel() >= 2 && !isOrderMode) {
      <button (click)="toggleEditMode()" class="edit-button" color="primary" mat-raised-button>
        {{ isEditMode ? 'Cancel Editing' : 'Edit Products' }}
      </button>
    }
    @if (this.getClearanceLevel() >= 1 && !isEditMode) {
      <button (click)="toggleOrderMode()" class="edit-button" color="primary" mat-raised-button>
        {{ isOrderMode ? 'Cancel Order' : 'Order Products' }}
      </button>
    }
    @if (isEditMode) {
      <button class="edit-button" mat-raised-button color="primary" (click)="saveChanges()">
        Save Changes
      </button>
    }
    @if (isOrderMode && orderItems.size > 0) {
      <button class="edit-button" mat-raised-button color="primary" (click)="submitOrder()">
        Submit Order
      </button>
    }
    @if (hasStartedScanning && scannedAdditions.size > 0) {
      <button class="edit-button" mat-raised-button color="primary" (click)="confirmScannedAdditions()">
        Confirm Scanned Additions
      </button>
    }
  </div>
  @if (loading) {
    <div class="loading-spinner">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  }
  @if (!loading && products.length === 0) {
    <div class="no-results">
      No products found. @if (route.snapshot.queryParams['name']) {
      Try a different search term.
    }
    </div>
  }
  <form [formGroup]="productForm">
    <table>
      <thead>
      <tr>
        <th (click)="sortProducts('name')" draggableColumn resizableColumn>
          Name
          @if (sortColumn === 'name') {
            <mat-icon>{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
          }
        </th>
        <th (click)="sortProducts('stock')" draggableColumn resizableColumn>
          Stock
          @if (sortColumn === 'stock') {
            <mat-icon>{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
          }
        </th>
        <th (click)="sortProducts('category')" draggableColumn resizableColumn>
          Category
          @if (sortColumn === 'category') {
            <mat-icon>{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
          }
        </th>
        <th (click)="sortProducts('description')" draggableColumn resizableColumn>
          Description
          @if (sortColumn === 'description') {
            <mat-icon>{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
          }
        </th>
        <th draggableColumn resizableColumn>Image</th>
        @if (this.getClearanceLevel() >= 2) {
          @if (!isEditMode) {
            <th draggableColumn resizableColumn>Actions</th>
          }
        }
      </tr>
      </thead>
      <tbody formArrayName="products">
        @if (isEditMode) {
          @for (productGroup of productsFormArray.controls; track $index) {
            <tr [formGroupName]="$index">
              <td resizableColumn>
                <mat-form-field appearance="fill">
                  <input matInput [formControlName]="'name'" class="custom-input">
                </mat-form-field>
              </td>
              <td resizableColumn>
                <mat-form-field>
                  <input matInput type="number" [formControlName]="'stock'" class="custom-input">
                </mat-form-field>
              </td>
              <td resizableColumn>
                <mat-form-field>
                  <input matInput [formControlName]="'category'" class="custom-input">
                </mat-form-field>
              </td>
              <td resizableColumn>
                <mat-form-field>
                  <input matInput [formControlName]="'description'" class="custom-input">
                </mat-form-field>
              </td>
              <td resizableColumn>
                <mat-form-field>
                  <input matInput [formControlName]="'image'" class="custom-input">
                </mat-form-field>
              </td>
            </tr>
          }
        } @else if (showPendingChanges && getInProgressAdditions().length > 0) {
          @for (product of getInProgressAdditions(); track $index) {
            <tr>
              <td resizableColumn>{{ product.name }}</td>
              <td resizableColumn>{{ product.stockDisplay }}</td>
              <td resizableColumn>{{ product.category }}</td>
              <td resizableColumn>{{ product.description }}</td>
            </tr>
          }
        } @else if (isOrderMode) {
          @for (product of products; track $index) {
            <tr>
              <td resizableColumn>{{ product.name }}</td>
              <td resizableColumn>{{ product.stock }}</td>
              <td resizableColumn>{{ product.category }}</td>
              <td resizableColumn>{{ product.description }}</td>
              <td resizableColumn>
                <img [src]="product.image || 'https://thumb.ac-illust.com/b1/b170870007dfa419295d949814474ab2_t.jpeg'"
                     height="50"
                     width="50"
                     alt="Product image"
                     class="expandable-image"
                     (click)="expandImage($event)"/>
              </td>
              <td resizableColumn>
                <button class="edit-button" color="primary" mat-raised-button (click)="addToOrder(product)">
                  +
                </button>
                <span>{{ orderItems.get(product.id) || 0 }}</span>
                <button class="edit-button" color="warn" mat-raised-button (click)="removeFromOrder(product)">
                  -
                </button>
              </td>
            </tr>
          }
        } @else {
          @for (product of products; track $index) {
            <tr>
              <td resizableColumn>{{ product.name }}</td>
              <td resizableColumn>{{ product.stock }}</td>
              <td resizableColumn>{{ product.category }}</td>
              <td resizableColumn>{{ product.description }}</td>
              <td resizableColumn>
                <img [src]="product.image || 'https://thumb.ac-illust.com/b1/b170870007dfa419295d949814474ab2_t.jpeg'"
                     height="50"
                     width="50"
                     alt="Product image"
                     class="expandable-image"
                     (click)="expandImage($event)"/>
              </td>
              @if (this.getClearanceLevel() >= 2) {
                <td resizableColumn>
                  <button class="edit-button" color="warn" mat-raised-button (click)="deleteProduct(product.id)">
                    Delete
                  </button>
                </td>
              }
            </tr>
          }
        }
      </tbody>
    </table>
  </form>
</div>
@if (showExpandedImage) {
  <div class="image-modal" (click)="closeExpandedImage()">
    <span class="close-btn" (click)="closeExpandedImage()">&times;</span>
    <img [src]="expandedImageSrc" alt="Expanded product image" (click)="$event.stopPropagation()">
  </div>
}
